package robot

import (
	"bytes"
	"fmt"
	"os"

	"github.com/robocorp/robo/cli/config"
	"github.com/robocorp/robo/cli/paths"
	yaml "gopkg.in/yaml.v3"
)

// Prefixed to all generated robot.yaml files
const header = `# This file was automatically generated by robo from pyproject.toml.
# Any changes to this file do not affect the original configuration
# and can be overwritten at any point.
`

type RobotYaml struct {
	Tasks        map[string]*Task `yaml:"tasks"`
	Devtasks     map[string]*Task `yaml:"devTasks"`
	Conda        string           `yaml:"condaConfigFile,omitempty"`
	PreRun       []string         `yaml:"preRunScripts,omitempty"`
	Environments []string         `yaml:"environmentConfigs,omitempty"`
	Ignored      []string         `yaml:"ignoreFiles"`
	Artifacts    string           `yaml:"artifactsDir"`
	Path         []string         `yaml:"PATH"`
	Pythonpath   []string         `yaml:"PYTHONPATH"`
}

type Task struct {
	Task    string   `yaml:"robotTaskName,omitempty"`
	Shell   string   `yaml:"shell,omitempty"`
	Command []string `yaml:"command,omitempty"`
}

func NewFromConfig(cfg config.Config) RobotYaml {
	return RobotYaml{
		Ignored:    []string{".gitignore"},
		Path:       []string{"."},
		Pythonpath: []string{"."},
		Artifacts:  cfg.OutputDir,
	}
}

func (it RobotYaml) Encode() ([]byte, error) {
	var buf bytes.Buffer
	enc := yaml.NewEncoder(&buf)
	enc.SetIndent(2)

	if err := enc.Encode(it); err != nil {
		return nil, err
	}

	content := append([]byte(header), buf.Bytes()...)
	return content, nil
}

func (it RobotYaml) Pretty() string {
	if content, err := it.Encode(); err == nil {
		return string(content)
	} else {
		return fmt.Sprintf("%v", it)
	}
}

func (it *RobotYaml) SaveAs(path string, force bool) error {
	exists, err := paths.Exists(path)
	if err != nil {
		return err
	}

	if exists && !force {
		return fmt.Errorf("File already exists: %v", path)
	}

	content, err := it.Encode()
	if err != nil {
		return err
	}

	return os.WriteFile(path, content, 0o666)
}
